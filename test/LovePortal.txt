#Requires AutoHotkey v2.0
#Include ../../AllText.ahk
#Include ../../Modules.ahk
#Include ../../FindText.ahk
#Include ../../../TinyTaskRE.ahk
#Include LoveModules.ahk
global connection

global playerhosting := false
; LovePortal(world) {
;     global SelectedWorldd  ; Ensure SelectedWorldd is global
;     SelectedWorldd := world ; Assign world to SelectedWorldd
    
;     if (world == "Namek") {
;         namekworld()
;     } else if (world == "Shibuya") {
;         shibuyaworld()
;     }
; }

class LovePortal_VAR {
    static MatchStarted := "|<>*92$250.0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001z0000000000000000000000Ds000Tk07w00000000Dy0001zk0000000000000001zrw03zU0zs000Ds001ss000TzsDk0000003w00000Dzzs0Tz07zk001zk0071k003sTlzk000000Tw00000sDzk1kQ0w7000DjU00s7000S07jzU000003zs00003Uw70C0s7UQ000sC003UQ003U0CsC000000C3U0000C1kQ0s3kQ0k0030s00C1k00S00T0s000000sC00000s61k3U7XU3000A3U0Us7001k01w3U0000030s04003UM70C0CS0ADzxkDkzvUTs07007kDkTztzzw3wDz03y1UQ0s0Tk0nzzz0zjzy1zk0M3Uz0zXzzzzzkDvzz0zs61k3U0y03TbXw1Ty7s7zk3UTbw1zzzzzwz0TzUyDzUM70C03k0Dk4700T07UE7UC1zz00TU8D10k07k0xw01UQ0s0700y00M01s0600C0M1zs01w00s0100S01z0061k3U0803k01U0700M00Q1k0TU07U03U0001k03s00M70C0000S00600M01U01k700S00Q00C00U06007001UQ0s4021s00Q01U06003UC00Q01k00s0300M00Q0061k3UM087081w1w0ks00C0w00s0C003U6S030S1U00M70C1k1UQ3s7kDkDrUD0M1w03kDs7kC1zw3w3s60w1UQ0s70C1kDUT0z0zy1y1UDz0D0zUT0s7zkDk00M7k71k3US0s70y1w3w3zs7s61zz0w3i1w3UQ30z001UT0SD0C1w7UQ3s7kDkDzUTUM73w3kDs7kC1kA3w00C1w1zs0s7ty1k70T0T0SS1y1Us7kD0zUC0s70kDk7zs3U7zU3UTzs7001y0Q00s7s63UC0y0y003UQ30D0TzU00Q70C1rtUS007s0s01UTUMC003s0w00C1kC0C00D001UQ0s7061w00TU3U061y1Uw00TU3k00s70s0s00y0060k3UQ0M7k01y0D00M7s61k01y07U03UQ3U1k03s00s3061k1kTk07Q0z03UTUM3U0CQ0z00C1k70DU0Dk03UQ0QD071rUkQw3y0z3z3UDU3kw3z1Uw70T0z01zk8D1k1zs0DyDzzVzwzzzyTy0Dzy3zwTzzzs0zzzkzDzzzz03z00zkTzw3zlzwzkzk0Tzk3zkzzzz00zwzzsDzzzs03k00Q0C701w0z0y1w00Tw03w0yT3s00z0zy0Dzlz000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000U"
}
class LovePortal_Namek {
    static Namek_PO1 := {
        Value: "yes",
        Cords: ""
    }
    static Namek_PO2 := {
        Value: "yes",
        Cords: ""
    }
    static Namek_PO3 := {
        Value: "yes",
        Cords: ""
    }
}

; class LovePortal_Portals {
;     static Namek := {
;         Value: "|<>*87$120.TzzzzzzzzzzzzzzzzzzzTzzzzzzzzzzzzzzzzzzzTzzzzzzzzzzzzzzzzzzzTzzzzzzzzzzzzzzzzzzzTzzzzzzzzzzzzzzzzzzzTzyTzzzzzzzzzzzzzztzT0CDzzzzzDyDXzzzzzszT06Dzzzzz7y7VzzzzzszT02Dzzzzz7y3VzzzzzszT72Dzzzzy1y3VzzzzzszT7UDWN7sA1y1VWM37WMXT72D0M1U41y0V0M030M3T02C0M1U61y000M000M3T06CAMkX77yA0AMkUAM7T0CAQMs077yA0QMlkQM7T3yCAMsUT7yC0AMlkAM7T7y60MsVD1yD00Mlk0M3T7y70MsU71yDX0Mll0MVT7z7WNtsDVyDnWMlnWNnTzzzzzzzzzzzzzzzzzzzTzzzzzzzzzzzzzzzzzzzTzzzzzzzzzzzzzzzzzzzTzzzzzzzzzzzzzzzzzzzU",
;         Cords: "&X, &Y, 999-150000, 644-150000, 999+150000, 644+150000, 0, 0"
;     }
;     static DoubleDungeon := {
;         Value: "|<>*95$61.zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzyTtzzw0zzzz7wTzy07zzzXyDzz03zzzlz7zzXkzzzsbXzzlwQDDA1lsDsyA1XW0Mk3wT00ll0AM1yDUA8sX2AMz7UD4QFV40TXUX2A8lX0zk0k3040kVDs0w1k20sE3w1z3wH8yC3zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz",
;         cord: "&X, &Y, 1166-150000, 634-150000, 1166+150000, 634+150000, 0, 0"
;     }
; }


LovePortal(hosting, position) {
    global playerhosting
    playerhosting := hosting

    if (playerhosting == true) {
        Host()
    } else {
        NonHost()
    }
}

NonHost() {
    findvoting_Love()

}
findvoting_Love() {
    loop {
        if (ok := FindText(&X, &Y, 925-150000, 109-150000, 925+150000, 109+150000, 0, 0, voteDectect)) {
            ; if find voting ui then start countdown
            CountdownLove(0, "Found Voting UI")
            Sleep(5000)
            ; Presses yes button for the vote
            Sleep(1000)
        
            LovePosition()
            Sleep(500)
            break
            ; CountdownLove(20, "")
        }
    }
}

Host() {
    baseX := 531
    baseY := 432
    
    ; Grid spacing
    colSpacing := 160
    rowSpacing := 150
    
    ; Track scrolling
    scrollCount := 0
    maxScrolls := 3

    if (FindText(&X, &Y, 602-150000, 259-150000, 602+150000, 259+150000, 0, 0, LobbyCheck)) {
        BetterClick(1495, 227)
        Sleep(1000)
        Send("{Tab}")
        Sleep(100)
        Send("{j}")
        Sleep(2000)
        BetterClick(1180, 326 - 10)
        
        text := "love"
        for each, char in StrSplit(text) {
            Send(char)
            Sleep(100)
        }
        Sleep(1000)

        WinGetPos(&winX, &winY, &winWidth, &winHeight, "A")

        while (scrollCount <= maxScrolls) {
            row := 0
            col := 0
            WorldLoaded := false

            while (row < 3) {
                while (col < 6) {
                    SmoothMouseMove(baseX + (col * colSpacing), baseY + (row * rowSpacing))
                    Sleep(500) 

                    if (FindText(LovePortal_Portals.Namek.Cords, Love_NAMEK)) {
                        WorldLoaded := true
                        MouseGetPos(&mouseX, &mouseY)
                        BetterClick(mouseX, mouseY)
                        
                        loop {
                            if (FindText(&X, &Y, 744-150000, 554-150000, 744+150000, 554+150000, 0, 0, usebutton)) {
                                BetterClick(X, Y)
                                Sleep(2000)
                                
                                loop {
                                    if (ok := FindText(&X, &Y, 787-150000, 549-150000, 787+150000, 549+150000, 0, 0, create)) {
                                        BetterClick(X, Y)
                                        Sleep(100)
                                        break
                                    }
                                }

                                loop {
                                    if (ok:=FindText(&X, &Y, 962-150000, 550-150000, 962+150000, 550+150000, 0, 0, cancelPortal))
                                        {
                                            BetterClick(X, Y)
                                            Sleep(10000)
                                            break
                            
                                            
                                        }
                                }
                                loop {
                                    if (ok:=FindText(&X, &Y, 1398-150000, 829-150000, 1398+150000, 829+150000, 0, 0, aftercanelstart))
                                    {
                                        BetterClick(X, Y)

                                        Sleep(100)
                                        Countdown(0, "Loading into [Namek village]")
                                        Sleep(2000)
                                        findvoting_Love()
                                        Sleep(1000)
                                        break
                                    }
                                }
                                                       
                              
                                break
                            }
                        }
                    }
                    col++
                }
                col := 0
                row++
            }

            if (!WorldLoaded) {
                SmoothMouseMove(baseX, baseY + (2 * rowSpacing))
                Sleep(200)
                Send("{WheelDown}")
                Sleep(1000)
                scrollCount++
            } else {
                break
            }
        }
    }
}


CountdownLove(seconds, text) {
    global CountdownText
    if seconds == 0 {
        CountdownText.Text := text  ; Clear the countdown text
    } else {
        Loop (seconds) {
            CountdownText.Text := "Starting in " seconds - A_Index " seconds..."
            Sleep(1000)
        }
        CountdownText.Text := ""  ; Clear the countdown text
        LoveStartTinyTask()
    }
}


LoveStartTinyTask() {
    global connection
    ; Starts tiny task
    connection.Text := "[CONNECTED]"
    Send("{F8 down}")
    Sleep(100)
    Send("{F8 up}")
    Sleep(1000)
    Loop {
        if (ok := FindText(&X, &Y, 1040-150000, 345-150000, 1040+150000, 345+150000, 0, 0, PortalPicker)) {
            Sleep(1000)
            Send("{F8 down}")
            Sleep(100)
            Send("{F8 up}")
            Sleep(500)
            LoveCollectRewards()
            CountdownText.Text := ""
            break
        } else {
            if (ok := FindText(&X, &Y, 667-150000, 247-150000, 667+150000, 247+150000, 0, 0, Failed)) {
                Sleep(1000)
                Send("{F8 down}")
                Sleep(100)
                Send("{F8 up}")
                Sleep(500)
                Countdown(0, "foundsomething failed")
                Sleep(2000)
                LovePickPortalsAGAIN()
                CountdownText.Text := ""
                break
            } else {
                if (ok := FindText(&X, &Y, 668-150000, 247-150000, 668+150000, 247+150000, 0, 0, shibuyafailed)) {
                    Sleep(1000)
                    Send("{F8 down}")
                    Sleep(100)
                    Send("{F8 up}")
                    Sleep(500)
                    Countdown(0, "foundsomething failed")
                    Sleep(2000)
                    LovePickPortalsAGAIN()
                    CountdownText.Text := ""
                    break
                }
            }
        }
    }
}


LoveCollectRewards() {
    ; Define portal positions
    portals := [
        {x: 722, y: 500},  ; Left portal
        {x: 960, y: 500},  ; Middle portal
        {x: 1194, y: 499}  ; Right portal
    ]

    ; Function to check a specific world type
    CheckWorldType(worldType) {
        for portal in portals {
            BetterMouseMove(portal.x, portal.y)
            Sleep(500)
            
            switch worldType {
                case "Namek":
                    if (FindText(&X, &Y, 1292-150000, 617-150000, 1292+150000, 617+150000, 0, 0, Namek)) {
                        BetterClick(portal.x, portal.y + 120)
                        Sleep(2000)
                        Yesbutton()
                        return true
                    }
                case "Shibuya":
                    if (FindText(&X, &Y, 1062-150000, 581-150000, 1062+150000, 581+150000, 0, 0, shibuya)) {
                        BetterClick(portal.x, portal.y + 120)
                        Sleep(2000)
                        Yesbutton()
                        return true
                    }
                case "Spider":
                    if (FindText(&X, &Y, 1061-150000, 618-150000, 1061+150000, 618+150000, 0, 0, spider)) {
                        BetterClick(portal.x, portal.y + 120)
                        Sleep(2000)
                        Yesbutton()
                        return true
                    }
            }
            
            ; Check next portal
            if (A_Index < portals.Length) {
                BetterClick(portal.x, portal.y)
                Sleep(2000)
            }
        }
        return false
    }

    ; Check worlds in priority order
    if (!CheckWorldType("Namek")) {
        if (!CheckWorldType("Shibuya")) {
            CheckWorldType("Spider")
        }
    }
}

LoveYesbutton() {
    loop {
        if (ok := FindText(&X, &Y, 841-150000, 568-150000, 841+150000, 568+150000, 0, 0, yes)) {
            BetterClick(X, Y)
            Sleep(500)
            CancelButton()
            Sleep(1000)
            break
        } else {
            if (ok := FindText(&X, &Y, 853-150000, 556-150000, 853+150000, 556+150000, 0, 0, darkerYes)) {
                BetterClick(X, Y)
                Sleep(2000)
                CancelButton()
                Sleep(1000)
                break
            }
        }
    }
}

LoveCancelButton() {
    ; global presents
    loop {
        if (ok := FindText(&X, &Y, 961-150000, 569-150000, 961+150000, 569+150000, 0, 0, cancel)) {
            BetterClick(X, Y - 20)
            Sleep(2000)
            Sleep(500)
            BetterClick(X, Y)
            Sleep(500)
            BetterClick(X, Y)
            Sleep(500)
            BetterClick(X, Y)
            Sleep(500)
            BetterClick(X, Y)
            Sleep(1000)
            PickPortalsAGAIN()
            break
        } 
    }
}

 LovePickPortalsAGAIN() {
     global playerhosting
     if (playerhosting == true) {
         Namek_lovee()
     } else {
         NonHost()
     }
 }

Namek_lovee() {
    ; Initialize base coordinates and spacing
    baseX := 531
    baseY := 432
    colSpacing := 160
    rowSpacing := 150

; Track scrolling
scrollCount := 0
maxScrolls := 3

MouseMove(546, 813)
Sleep(1000)
BetterClick(432, 813)

while (scrollCount <= maxScrolls) {
    row := 0
    col := 0
    namekFound := false

    while (row < 3) {
        while (col < 6) {
            SmoothMouseMove(baseX + (col * colSpacing), baseY + (row * rowSpacing))
            Sleep(1000)

            if (FindText(&X, &Y, 697-150000, 603-150000, 697+150000, 603+150000, 0, 0, Namek)) {
                namekFound := true
                MouseGetPos(&mouseX, &mouseY)
                BetterClick(mouseX, mouseY)
                Sleep(1000)
                
                if (FindText(&X, &Y, 838-150000, 568-150000, 838+150000, 568+150000, 0, 0, yesagain)) {
                    BetterClick(X, Y)
                    StartTinyTask()
                    Sleep(2000)
                    break
                }
            }
            col++
        }
        col := 0
        row++
        if (namekFound)
            break
    }

    if (!namekFound) {
        SmoothMouseMove(baseX, baseY + (2 * rowSpacing))
        Sleep(200)
        Send("{WheelDown}")
        Sleep(1000)
        scrollCount++
    } else {
        break
    }
}
}


LovePosition() {
    ; DETECT MATCH STARTED
    BetterClick(880, 180) ;Clicks the yes button for the voting ui
    loop {
        if (ok:=FindText(&X, &Y, 962-150000, 844-150000, 962+150000, 844+150000, 0, 0, LovePortal_VAR))
            {
              Sleep(500) ;TIMEOUT
              ; Lets Zoom out real quicky
              LookDown()
              Sleep(1000)
              PlaceDownSpeedWagon()
              Sleep(1000)
              SpeedWagonSpectate() ; Clicks Spectate
              Sleep(500)
              Respawn()
              break


            }
    }

}

Respawn() {
    ; This function will find the position the player is at and also move the camera by using the spectate mode

}